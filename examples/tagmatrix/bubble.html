<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Bubble Chart</title>
    <script type="text/javascript" src="../../d3.js"></script>
    <script type="text/javascript" src="../../d3.layout.js"></script>
    <script type="text/javascript" src="../../d3.csv.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script type="text/javascript" src="tagmatrix.js"></script>
    <link type="text/css" rel="stylesheet" href="bubble.css"/>
  </head>
  <body>
<div id="scatter-bubble-chart">
<script type="text/javascript">

function roundNumber(num, dec, raise) {
  num=parseFloat(num);
  dec=Math.pow(10,dec);
  var result = Math.floor(num*dec)/dec;
  return result * (raise ? raise : 1);
}

d3.csv("./tagmatrix.csv", function(data) { 
    var maxvalx   = 0, minvalx  = 0,
        maxvaly   = 0, minvaly  = 0,
        minc      = 0, maxc     = 0,
        sampsize  = 0;
    var label_array = new Array(),
        val_array = new Array();

    sampsize = Math.min( data.length, 40);

    for (var i=0; i < sampsize; i++) {
        var color = roundNumber(data[i].color, 8, 1);
        var x     = roundNumber(data[i].x, 8, 1);
        var y     = roundNumber(data[i].y, 8, 10);
        var size  = Math.abs(roundNumber(data[i].z, 10,40000));
        label_array[i] = data[i].label;
        val_array[i] = { label: label_array[i], x: x, y:y, size: size, color: color  };
        minc = Math.min(minc, color);
        maxc = Math.max(maxc, color);
        maxvalx = Math.max(maxvalx, x );
        maxvaly = Math.max(maxvaly, y );
        minvalx = Math.min(minvalx, x );
        minvaly = Math.min(minvaly, y );
       //document.write('<p>Label: ' + label_array[i] + '</p>');
     }

     //maxvalx = (1 + Math.floor(maxvalx / 10)) * 10;   
     //maxvaly = (10 + Math.floor(maxvaly / 10)) * 10;
     //minvalx = (Math.floor(minvalx / 10)) * 10;   
     //minvaly = (Math.floor(minvaly / 10)) * 10 - 100; 

     //document.write('<p>Max Y: ' + minvaly + '</p>');
     console.log({'vals':val_array});

    /* minc = roundNumber(minc, 4);
     maxc = roundNumber(maxc, 4);
     minvaly = roundNumber(minvaly, 4);
     maxvaly = roundNumber(maxvaly, 4);
     minvalx = roundNumber(minvalx, 4);
     maxvalx = roundNumber(maxvalx, 4);
*/
     console.log(' X: ', minvalx,maxvalx ); 
     console.log(' Y: ', minvaly,maxvaly ); 
   
    var w = 900,
        h = 700,
        p = 100,
        s = d3.scale.linear().domain([ 0,100] ).range([0.3,1.3]).nice();
        c = d3.scale.linear().domain([ minc,maxc]).range(["rgb(40,40,120)","rgb(250,50,50)"]).interpolate(d3.interpolateRgb)
        x = d3.scale.linear().domain([ minvalx, maxvalx]).range([0, w]);//.nice(),
        y = d3.scale.linear().domain([ minvaly, maxvaly ]).range([h, 0]);//.nice();

    var vis = d3.select("#scatter-bubble-chart")
       .data([val_array])
     .append("svg:svg")
       .attr("width", w + p * 2)
       .attr("height", h + p * 2)
     .append("svg:g")
       .attr("transform", "translate(" + p + "," + p + ")");


    var rules = vis.selectAll("g.rule")
      .data(x.ticks(12))
     .enter().append("svg:g")
       .attr("class", "rule");

   // Draw grid lines
   rules.append("svg:line")
    .data(x.ticks(10))
    .attr("x1", x)
    .attr("x2", x)
    .attr("y1", 0)
    .attr("y2", h - 1)
    .attr('stroke', '#666');

   rules.append("svg:line")
    .attr("class", function(d) { return d ? null : "axis"; })
    .data(y.ticks(12))
    .attr("y1", y)
    .attr("y2", y)
    .attr("x1", 0)
    .attr("x2", w - 10)
    .attr('stroke', '#666');

   // Place axis tick labels
   rules.append("svg:text")
    .attr("x", x)
    .attr("y", h + 15)
    .attr("dy", "1em")
    .attr("text-anchor", "middle")
    .text(x.tickFormat(10))
    .text(String);

   rules.append("svg:text")
    .data(y.ticks(12))
    .attr("y", y)
    .attr("x", -20)
    .attr("dy", ".55em")
    .attr("text-anchor", "end")
    .text(y.tickFormat(5));


    // Draw xy scatterplot
    vis.selectAll("circle.line")
       .data(val_array)
     .enter().append("svg:circle")
       .attr("class", "line")
       .attr("fill", function(d) { return c(d.color); } )
       .attr("cx", function(d) { return x(d.x); })
       .attr("cy", function(d) { return y(d.y) - 6; })
       .attr("r", function(d) { return Math.sqrt( 6*d.size / Math.PI); });

    // add bubble labels: in two steps
    vis.selectAll("g.rule")
        .data(val_array)
      .append("svg:text")
         .attr("text-anchor", "left")
         .attr("x", function(d) { return x(d.x); })
         .attr("y", function(d) { return y(d.y) - Math.sqrt( 5*d.size / Math.PI) - 30; })
         .attr("dy", function(d){ return s(d.size)+"em"; })
         .attr("fill", function(d) { return c(d.color); })
         .attr("clip", "inherit")
         .text(function(d) { return d.label; });

     vis.selectAll("g.rule")
        .data(val_array)
       .enter().append("svg:text")
         .attr("text-anchor", "left")
         .attr("x", function(d) { return x(d.x); })
         .attr("y", function(d) { return y(d.y) + Math.sqrt( 5*d.size / Math.PI) + 4; })
         .attr("dy", function(d){ return s(d.size)+"em"; })
         //.attr("fill","#990000")
         .attr("fill",function(d) { return c(d.color); })
         .attr("clip", "inherit")
         .text(function(d) { return d.label; });

     
});
</script>
</div>
  </body>
</html>
